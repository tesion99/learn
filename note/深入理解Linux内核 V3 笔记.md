# 深入理解Linux内核 V3 笔记

### 操作系统基本概念

**内核(kernel)** ---- 任何计算机系统都包含一个名为操作系统的基本程序集合。在这个集合里，最重要的程序称为**内核**

操作系统必须完成的两个主要目标:

- 与硬件部分交互，为包含在硬件平台上的所有低层可编程部件提供服务
- 为运行在计算机系统上的应用程序(即用户程序)提供运行环境



CPU两种执行模式

- **用户态(User Mode)** ---- 用户程序的非特权模式
- **内核态(Kernel Mode)** ---- 内核的特权模式



**进程(process)** ---- 程序执行时的一个实例或者一个运行程序的执行上下文

**地址空间(address space)** ---- 允许进程引用的内存地址集合

**微内核(microkernel)**操作系统只需要内核有一个很小的函数集、，通常包括几个同步原语、一个简单的调度程序和进程间通信机制。



**文件系统**

- **硬链接与软链接**

  - 硬链接(hard link)是包含在目录中的文件名

    - 硬链接的限制

      - 不允许给目录创建硬链接。因为可能把目录树变为环形，从而就不可能通过名字定位一个文件
      - 只有在同一文件系统中的文件之间才能创建硬链接

      ```shell
      # 创建P1的硬链接P2
      ln P1 P2
      ```

      

  - 软链接(soft link)，也成符号链接(symbolic link)

    - 符号链接是短文件，其包含有另一个文件的任意一个路径名。路径名可以指向位于任意一个文件系统的任意文件或目录，甚至一个不存在的文件。

      ```shell
      # 创建P1的软链接P2
      ln -s P1 P2
      ```

- **文件类型**

  - 普通文件(regular file)
  - 目录
  - 符号链接
  - 面向块的设备文件
  - 面向字符的设备文件
  - 管道(pipe)与命名管道(named pipe)
  - 套接字(socket)

- 文件描述符与索引节点

  UNIX对*文件内容*和*描述文件的信息*给出了清楚的区分

  文件系统处理文件需要的所有信息包含在一个名为**索引节点(inode)**的数据结构中。文件系统用索引节点来标识文件

- **访问权限和文件模式**

  3种访问权限: 可读、可写、可执行

  3种附加标记: 

  - **suid**: 进程执行一个文件时通常保持**进程拥有者**的UID，如果设置了可执行文件的suid标志位，进程就获得**该文件拥有者**的UID
  - **sgid**: 同上类似，进程获得该文件用户组的ID
  - **sticky**: 设置了sticky标志位的可执行文件相当于向内核发出一个请求，当程序执行结束以后，依然将它保留在内存(**注: 该标志已过时**)



**内核概述**

1. 实际上，一些CPU可以有两种以上的执行状态；但是所有标准的UNIX内核都仅仅利用了**内核态**和**用户态**

2. 当一个程序在用户态下执行时，它不能直接访问内核数据结构或内核的程序；当应用程序在内核态下运行时，这些限制不再有效

   每种CPU模型都为从用户态到内核态的转换提供了特殊指令

- **进程/内核模式**

  UNIX系统除用户进程外，还包括几个所谓内核线程(kernel thread)的特权进程，其具有如下特点：

  - 它们以内核态运行在内核地址空间
  - 它们不与用户直接交互
  - 它们通常在系统启动时创建，然后一直处于活跃状态直到系统关闭

- 进程实现

  每个进程由一个进程描述符(process descriptor)表示；当内核暂停一个进程的执行时，就把几个相关处理器寄存器的内容保存在进程描述符中，这些寄存器包括:

  - 程序计数器(PC)和栈指针(SP)寄存器

    程序计数器中所存的值指向下一条将要执行的指令

  - 通用寄存器

  - 浮点寄存器

  - 包含CPU状态信息的处理器控制寄存器

  - 用来跟踪进程对RAM访问的内存管理寄存器

  **内核控制路径(kernel control path)**表示内核处理系统调用、异常或中断所执行的指令序列

- 进程地址空间

  每个进程运行在它的私有地址空间

  在用户态下运行的进程涉及到私有栈、数据区和代码区

  当在内核态运行时，进程访问内核的数据区和代码区，但使用另外的私有栈

- 同步喝临界区

  **临界区(critical region)**是这样的一段代码，进入这段代码的进程必须完成，之后另一个进程才能进入